stages:
  - linter
  - compilemessages
  - tests

linter_job:
  image: python:3.5.9-alpine
  stage: linter
  tags:
    - docker
  before_script:
    - cd backend/
    - python -m pip install --upgrade pip && python -m pip install flake8 flake8-builtins flake8-bugbear
  script:
    - flake8
  only:
    - merge_requests

compilemessages_job:
  image: python:3.5.9-alpine
  stage: compilemessages
  tags:
    - docker
  before_script:
    - apk add gettext
  script:
    - cd backend/common/
    - ash compilemessages.sh en
    - ash compilemessages.sh ru
  only:
    - merge_requests

tests_job:
  stage: tests
  tags:
    - shell
  script:
    - cd devops/docker/
    - docker-compose -f test-docker-compose.yml up --build --force-recreate -V --abort-on-container-exit --exit-code-from vdi-test-tornado
  only:
    refs:
      - merge_requests
      - schedules
    variables:
      # - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^release.*$/
      - $BY_SCHEDULE == "true"