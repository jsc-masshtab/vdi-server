# Автоматический пул (VeiL Broker 3+)

Работа с автоматическими пулами ВРС использующих в качестве шаблона настроенные образы MS Windows позволяет
автоматизировать процесс ввода ВМ в домен и доменные группы MS AD.

## Процесс подготовки ВМ включает в себя следующие шаги:
1. Проверка и включение настройки удаленного доступа на VeiL ECP.
1. Задание имени хоста (hostname) по имени ВМ.
1. Заведение ВМ в домен (исключительно для OS Windows) MS AD с использованием powershell из ВМ.
1. Заведение ВМ в группу (контейнер) MS AD с использованием LDAP напрямую на контроллере домена.

## Создание автоматического пула с указанием необходимости подготовки ВМ

### Подготовительные шаги
1. Подготовить базовый шаблон ВМ (Windows 10) [veil-guest-utils](../vm/guest_agent.md)
1. Настроить [расширенную интеграцию](../active_directory/ad_extend.md) с MS AD на брокере

### Создание автоматического пула
Создание автоматического пула производится с помощью кнопки **Добавить пул** в разделе **Пулы** панели администратора.

#### Общие параметры
Описание полей формы "волшебника" создания автоматического пула.

##### Имя пула
Будет использовано как [тег](https://veil.mashtab.org/docs/base/operator_guide/domains/tags) на ECP VeiL для всех созданных ВМ

##### Типы подключения
Типы подключения к ВМ в пуле которые будут доступны тонкому клиенту:
- RDP - rdp-подключение средствами ТК (подходит для рабочих мест на основе Linux)
- NATIVE_RDP - rdp-подключение средствами Windows rdp-клиента (подходит только для рабочих мест на основе Windows)
- SPICE - подключение будет проксироваться контроллером
- SPICE_DIRECT - подключение напрямую в ВМ

##### Контроллер 
Контроллер ECP VeiL, ранее добавленный в систему, на котором будет происходить создание ВМ.
Контроллер должен быть в активном статусе и отвечать на запросы брокера. Для версии 4.5 необходимо назначение 
пользователю роли **Администратор**.

##### Пул ресурсов
Предварительно созданный [пул ресурсов](https://veil.mashtab.org/docs/base/operator_guide/resource_pools) на выбранном выше контроллере.

##### Пример формы
![image](../../../_assets/vdi/pool/autopool_v3_1.png)

#### Параметры создания ВМ в пуле
##### Шаблон ВМ 
Предварительно созданный [шаблон](https://veil.mashtab.org/docs/base/operator_guide/domains/templates) для создания ВМ в пуле.

!!! info "Шаблон есть на ECP VeiL, но не отображается на брокере"
    При создании автоматического пула брокер отображает только шаблоны с виртуальными дисками.

!!! warning "Шаблон ВМ"
    С шаблоном одновременно может происходить только одно действие, если Вы планируете создавать сразу
    несколько пулов, то выполняйте создание последовательно. Оптимальным решением для использования 1 шаблона
    несколькими брокерами/автоматическими пулами — для каждого брокера/пула создать отдельный шаблон.

##### Шаблон имени ВМ
Имя шаблона не должно превышать 63 символа и может состоять из букв латинского алфавита, цифр и -. 
Ограничения вызваны тем, что имя ВМ будет назначено в качестве **hostname** при ее подготовки.

##### Наименование групп для добавления ВМ в AD
Указание на наименование контейнера для MS AD в который необходимо включить созданные ВМ при подготовке. В настоящий 
момент есть возможность включения только в **CN**, заведение в **OU** заблокировано.

!!! note "Наименование групп для добавления ВМ в AD"
    Если необходимость включения ВМ в группы отсутствует — оставьте поле пустым, тогда этот шаг будет пропущен.

##### Начальное количество ВМ 
Количество ВМ, которое будет создано вместе с пулом.


##### Максимальное количество создаваемых ВМ
Максимальное количество ВМ для пула (используется при расширении пула).

##### Шаг расширения пула 
Количество ВМ, которое будет создаваться при расширении пула.

##### Пороговое количество свободных ВМ
Значение при достижении которого будет запущено автоматическое расширение (создание новых ВМ из шаблона с шагом выше) пула.

##### Создать тонкие клоны 
ВМ созданные в пуле будут являться тонкими клонами шаблона, как результат создание будет происходить быстрее, однако
имеют ограничения по используемым дата-пулам. Подробнее можно ознакомиться в разделе 
[Типы пулов данных](https://veil.mashtab.org/docs/base/operator_guide/storage/info)

##### Подготавливать ВМ
Необходимость запуска процедуры подготовки ВМ после их создания. Включение в домен MS AD и группы CN для ВМ
выполняется только, если ранее была добавлена [служба каталогов](../active_directory/ad_extend.md).

!!! warning "Подготавливать ВМ"
    Если на пуле отсутствовал данный параметр в момент создания, то действовать он начнет только после его активации
    и для ВМ созданных **ПОСЛЕ**.

!!! note "Подготовка ВМ"
    Если в процессе создания пула подготовились не все ВМ или необходимо выполнить подготовку по изменившимся параметрам,
    при помощи кнопки **Подготовить ВМ** в разделе **Информация**. Данная кнопка продолжит подготовку ВМ с последнего 
    успешного действия. 

!!! warning "Удаление ВМ"
    Если пул или ВМ были удалены — не забудьте вывести ВМ из MS AD.    

##### Пример формы
![image](../../../_assets/vdi/pool/autopool_v3_2.png)