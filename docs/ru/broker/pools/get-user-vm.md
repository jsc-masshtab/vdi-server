# Алгоритм подбора ВМ пользователю

!!! info "Сокращения"
    **ВМ** - виртуальная машина на **ECP VeiL**.  
    **VDI** - **VeiL VDI** / **VeiL Broker**.  
    **АКТИВНАЯ ВМ** - ВМ, находящаяся в статусе **ACTIVE**/**исправно**. Статус обозначает, что на ВМ нет явных ошибок с точки зрения VDI.  
    **СВОБОДНАЯ ВМ** - ВМ, не закрепленная за конкретным пользователем.  
    **ЗАРЕЗЕРВИРОВАННАЯ ВМ** - ВМ, освобожденная вручную от пользователя администратором.  
    **ВКЛЮЧЕННАЯ ВМ** - ВМ со значением атрибута **СОСТОЯНИЕ** **ON**.  
    **ГОСТЕВОЙ АГЕНТ** - [Описание](../vm/guest_agent.md).

## Пользователь подключается к пулу в первый раз

1. Формируем список ВСЕХ **АКТИВНЫХ** и **СВОБОДНЫХ** ВМ пула выбранного пользователем.
2. Фильтруем список, оставив **ВКЛЮЧЕННЫЕ ВМ**.
3. Поиск ВМ среди **ВКЛЮЧЕННЫХ ВМ**, у которой доступен **ГОСТЕВОЙ АГЕНТ**.
4. Если гостевой агент нигде не отвечает, то берем первую включенную ВМ.
5. Если включенных ВМ нет, то возвращаем свободную ВМ.

## Пользователь имеет ранее выданную ВМ

Пользователю будет выдана ВМ, привязанная к нему, независимо от статуса ВМ.

!!! warning "Статус "Зарезервировано"
    Если в процессе работы администратор в ручном режиме освободит ВМ от пользователя, то этой ВМ присвоится статус 
    **зарезервировано**. Такая ВМ **не будет выдаваться** ни одному пользователю, до тех пор, пока администратор 
    в ручном режиме не назначит пользователя этой ВМ.