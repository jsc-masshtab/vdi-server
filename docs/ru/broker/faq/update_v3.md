# Обновление VeiL Broker 3.*

## Обновление с версии 3.0, используя iso-образ

!!! note "Примечание"
    Проверить текущую версию VeiL Broker и его компонентов можно командой `dpkg -l | grep veil`

!!! warning "Предупреждение"
    Во время обновления сервис будет недоступен. Выбрать допустимое время и выполнить резервное копирование ВМ.

1. Войти в систему, указав значение **Integrity level** равное **_63_** или 
   **Уровень целостности** - **_Высокий_** (для графического режима).
   
    !!! note "Стандартные репозитории пакетов"
        Если при установке были пропущены шаги по копированию стандартных дистрибутивов Astra Linux, 
        следует ознакомиться с шагами по копированию **_основного_** и **_devel_** дисков 
        в разделе [Установка системы](./install_v3.md).

1. Подключить новый iso-образ **VeiL Broker** и выполнить 
   команды для обновления:

    ```bash
    sudo mv /etc/apt/sources.list.d/media_cdrom_repo.list /etc/apt/sources.list.d/media_cdrom_repo.back
    sudo apt-get update
    ```

    !!! note "Примечание"
        Команда очистки старого репозитория актуальна для 3.*

    ```bash
    sudo mount /media/cdrom0
    cd ~
    sudo bash /media/cdrom0/install.sh > vdi_update.log
    ```
 
## Обновление с версии 3.0, используя внешний репозиторий

!!! note "Примечание"
    Проверить текущую версию VeiL Broker и его компонентов можно командой `dpkg -l | grep veil`

!!! warning "Предупреждение"
    Во время обновления сервис будет недоступен. Выбрать допустимое время и выполнить резервное копирование ВМ.

1. Войти в систему, указав значение **Integrity level** равное **_63_** или 
   **Уровень целостности** - **_Высокий_** (для графического режима).
   
    !!! note "Стандартные репозитории пакетов"
        Если при установке были пропущены шаги по копированию стандартных дистрибутивов Astra Linux, 
        следует ознакомиться с шагами по копированию **_основного_** и **_devel_** дисков 
        в разделе [Установка системы](./install_v3.md).

1. В директории /etc/apt/sources.list.d/ создать файл vdi.list и привести его к виду:
    
    ```bash
    deb https://veil-update.mashtab.org/veil-broker-prod-31 smolensk main
    ```
    где указана свежая версия репозитория с [сайта доступных версий](https://veil-update.mashtab.org/).
 
1. Выполнить команды для обновления:

    ```bash
    sudo mv /etc/apt/sources.list.d/media_cdrom_repo.list /etc/apt/sources.list.d/media_cdrom_repo.back
    sudo apt-get update
    ```

    !!! note "Примечание"
        Команда очистки старого репозитория актуальна для 3.*

1. Остановить сервисы VeiL Broker:

    ```bash
    sudo service vdi-pool_worker stop
    sudo service vdi-web stop
    sudo service vdi-monitor_worker stop
    ```
 
1. Выполнить и запустить сервисы VeiL Broker обратно:

    ```bash
    sudo apt-get upgrade
    sudo service vdi-pool_worker start
    sudo service vdi-web start
    sudo service vdi-monitor_worker start
    ```

## Миграция данных VeiL Broker 2.0 на версию 3.0.0

Перед началом миграции нужно убедиться, что все контроллеры активны и к ним можно 
подключиться. Скрипт миграции предоставляется по запросу.

### Команды для запуска на версии 2

1. Подключиться к серверу, на котором размещен VeiL VDI 2.1.4. 
   
    !!! note "Примечание"
        Если используется более ранняя версия, необходимо сначала обновить ее до 2.1.4.

2. Выполнить установку пакета _vdi-migration-tool_ 
```
sudo dpkg -i vdi-migration-tool_1.0-1_all.deb
```

3. Запустить скрипт миграции
```
cd /opt/veil-vdi/app && ./migrate.sh -v 2
```

4. Выполнить перенос получившихся файлов
```
/tmp/broker_pt_1.sql
/tmp/broker_pt_2.sql
/tmp/broker_pt_3.sql
```

### Команды для запуска на версии 3

1. Подключиться к серверу, на котором размещен VeiL VDI 3.0.0.

    !!! note "Примечание"
        1. Если планируется использовать версию новее, сначала нужно выполнить установку 3.0.0.
        1. Если ssh-подключение к версии 3.0.0 заблокировано, используйте SPICE/VNC 
           управление с контроллера ECP VeiL.

2. Разместить дампы памяти на сервере в каталоге **_tmp_**.

    !!! note "Примечание"
        Дампы памяти должны быть загружены в каталог, к которому будет доступ у пользователя 
        **_vdiadmin_**.
   
    ```
    /tmp/broker_pt_1.sql
    /tmp/broker_pt_2.sql
    /tmp/broker_pt_3.sql 
    ```

3. Выполнить установку пакета _vdi-migration-tool_ 
```
sudo dpkg -i vdi-migration-tool_1.0-1_all.deb
```

4. Запустить скрипт миграции
```
cd /opt/veil-vdi/app && ./migrate.sh -v 3
```

5. Задать пароли вновь созданным заблокированным пользователям. 

    !!! note "Примечание"
        На момент миграции в версии 3.0.0 не должно быть иных пользователей, кроме **_vdiadmin_**.
