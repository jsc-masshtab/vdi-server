# Обновление VeiL Broker с внешнего репозитория

!!! note "Примечание"
    Проверить текущую версию **VeiL Broker** и его компонентов можно командой `dpkg -l | grep veil`.

!!! warning "Предупреждение"
    Во время обновления сервис будет недоступен. Следует выбрать допустимое время и выполнить резервное копирование ВМ.

## Обновление VeiL Broker с 3.x на 3.x

Для обновления **VeiL Broker**, используя внешний репозиторий, необходимо выполнить следующие действия:

1. 1) Подключиться по протоколу SSH командой 

      `ssh <имя пользователя>@<IP-адрес машины, на которой установлен VeiL Broker>`
    
      Пример команды: `ssh astravdi@192.168.7.17`

    или 

    2) Войти в систему по протоколу SPICE/VNC через Web-интерфейс **ECP VeiL**, выполнить вход от имени учетной записи администратора 
       (по умолчанию **astravdi:Bazalt1!** ), указать значение **Integrity level** равное **63** или 
       **Уровень целостности** - **Высокий** (для графического режима).
   
    !!! note "Стандартные репозитории пакетов"
        Если при установке были пропущены шаги по копированию стандартных дистрибутивов Astra Linux, 
        следует ознакомиться с шагами по копированию **основного** и **devel** дисков 
        в разделе [Установка и настройка ОС](../../engineer_guide/install/prepare/install_os.md).

1. Подключить внешний репозиторий **VeiL Broker**:

    ```
    echo "deb https://veil-update.mashtab.org/veil-broker-prod-32 smolensk main" | sudo tee /etc/apt/sources.list.d/vdi.list
    ```
    где указана свежая версия репозитория с [сайта доступных версий](https://veil-update.mashtab.org/).
 
1. Выполнить команды для обновления:

    `sudo apt-get update`
     
    `sudo apt-get upgrade -y`
     
    `sudo rm -f /etc/apt/sources.list.d/vdi.list`
     
    `sudo apt-get update`
     
    !!! info "Просроченный корневой сертификат"
         Если при выполнении команды `sudo apt-get update` происходит ошибка 
         **"Данные из этого репозитория нельзя аутентифицировать, и поэтому потенциально 
         из небезопасно использовать"** \* необходимо выполнить следующие команды и повторить 
         процесс обновления:  
         `sudo sed -i '/mozilla\/DST_Root_CA_X3.crt/s/^/#/' /etc/ca-certificates.conf`  
         `sudo update-ca-certificates --fresh`  
         \* Орфография и пунктуация автора сохранены.

1. Перезапустить ВМ, на которой установлен **VeiL Broker**.  

## Обновление VeiL Broker с 4.х на 4.х

1. 1) Подключиться по протоколу SSH командой 

      `ssh <имя пользователя>@<IP-адрес машины, на которой установлен VeiL Broker>`
    
      Пример команды: `ssh astravdi@192.168.7.17`

    или 

    2) Войти в систему по протоколу SPICE/VNC через Web-интерфейс **ECP VeiL**, выполнить вход от имени учетной записи администратора 
       (по умолчанию **astravdi:Bazalt1!**), указать значение **Integrity level** равное **63** или 
       **Уровень целостности** - **Высокий** (для графического режима).
   
1. Прописать репозитории на серверах **VeiL Broker**. Для этого:

     - создать файл **veil-broker.list** с помощью команды
   
       `sudo touch /etc/apt/sources.list.d/veil-broker.list`
   
     - открыть его для редактирования с помощью команды
    
      `sudo nano /etc/apt/sources.list.d/veil-broker.list`

     - добавить путь к папке с обновлениями
    
      `deb http://veil-update.mashtab.org/veil-broker-prod-41 1.7_x86-64 main`

     - сохранить изменения, нажав **Ctrl+Х** и **Enter**.
 
1. Обновить списки пакетов с помощью команды
   `sudo apt-get update`.

1. Выполнить обновление пакетной базы командой: `sudo apt-get upgrade -y`.
