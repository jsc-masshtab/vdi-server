# Установка VeiL Broker 3.*

## Подготовка к установке
- [Требования к техническим средствам](../engineer_guide/hardware_requirements.md).
- [Создание ВМ в среде ECP VeiL](../engineer_guide/create_domains.md).
- [Установка ОС Astra Linux Special Edition версии 1.6 релиз Смоленск](../engineer_guide/install_os.md).
- Описание прочих требований и спецификация доступны в разделах:
  [Подготовка сервера](../spec/domain-req.md) и [Перечень портов](../spec/ports_info.md).

## Установка Virtual Appliance брокера (версия от 3.1.1)

!!! info "Virtual Appliance"
    Виртуальный аплайнс (Virtual Appliance, VA) **VA VeiL Broker** — это готовый образ виртуальной машины 
    (доступен в виде резервной копии ВМ), который необходимо распаковать в ECP VeiL.

1. Скаченную из личного кабинета последнюю версию **VA VeiL Broker** (шаблон преднастроенной ВМ) необходимо добавить в 
   файлы вашего хранилища **ECP VeiL**.
2. В окне файла **VeiL_VDI-\*.tar.zst** нажать кнопку **Обновить информацию о резервной копии**.
3. После завершения обновления информации необходимо войти в **Конфигурацию копии ВМ** и нажать **Восстановление ВМ**.
4. Выбрать сервер и пул данных (по необходимости).
5. После создания ВМ необходимо перейти во вкладку **Виртуальные машины** - <имя ВМ> - **Интерфейсы** и добавить 
   необходимый виртуальный интерфейс.
6. Включить ВМ **VeiL_VDI**. 
7. Web-интерфейс брокера будет доступен по https://server_ip_address, где необходимо указать IP-адрес сервера. По умолчанию пользователь 
   **_vdiadmin_** и пароль **_Bazalt1!_**. Список назначенных IP-адресов можно посмотреть таблице ВМ интерфейса ECP VeiL 
   или в самой ВМ в окне приложения **Терминал Fly** с помощью команды `ip a`.
8. Брокер готов к работе, дальнейшая настройка выполняется только в случае особой необходимости.

!!! info "Логин/пароль ВМ"
    Для работы в ВМ **VeiL_VDI** (**ОС Astra Linux Special Edition 1.6 - Смоленск**) по умолчанию используется пользователь 
      **_astravdi_**, пароль **_Bazalt1!_**.

## Установка брокера вручную

!!! attention "Внимание"
    Если на момент установки системы на сервере не доступна локальная сеть, **ОБЯЗАТЕЛЬНО** выполните отключение 
    интерфейса, иначе при установке `apache2` возникнет ошибка ломающая дальнейший сценарий установки.
    
![image](../../_assets/vdi/how_to/installation/network_disabled.png)

1. Для установки **VeiL Broker** необходимо зайти в окно управления **ECP VeiL**, перейти во вкладку 
   **Виртуальные машины** - <имя ВМ> - **CD-ROM**.
 
    В списке приводов нажать на название привода и в открывшемся диалоговом окне выполнить следующие действия:

    - примонтировать iso-образ установочного диска **VeiL Broker** (образ доступен в вашем ЛК), нажав кнопку 
      **Монтировать образ**;
    - откроется окно **Монтирование iso-образа**, в котором необходимо выбрать тип хранилища, 
      его наименование и iso-образ установочного диска **VeiL Broker**;
    - для сохранения изменений нажать кнопку **Монтировать**.

    Выбрать вкладку **>_Терминал**, перейти в окно ВМ и авторизоваться (логин и пароль, которые были 
    указаны при создании учетной записи ([см. рис.5 и рис.6](../engineer_guide/application.md)), указав значение **Integrity level** 
    равным **_63_** или уровень целостности равным **_Высокий_** (для графического режима).

1. После авторизации, перейти в окно приложения для ввода командной строки **Терминал Fly** 
   и выполнить следующие действия:
   
    - с записью результатов в log-файл

    ```bash
    sudo mount /media/cdrom && cd ~
    sudo bash /media/cdrom/install.sh > vdi_install.log
    sudo umount /media/cdrom
    ```
    
     - просто установка
    
    ```bash
    sudo mount /media/cdrom && cd ~
    sudo bash /media/cdrom/install.sh
    sudo umount /media/cdrom
    ```

1. Установка выполняется около 5 мин. После установки Web-интерфейс **VeiL Broker** будет доступен по 
   https://server_ip_address, где необходимо указать IP-адрес сервера. По умолчанию пользователь **_vdiadmin_** и пароль **_Bazalt1!_**. Список назначенных 
   IP-адресов можно посмотреть в окне приложения **Терминал Fly** с помощью команды `ip a`.

1. Войти в **Панель управления** → **Безопасность** → **Политика безопасности** → **Политики учетной записи** и 
   выполнить настройки создания новых пользователей:
   
    - в окне **Политика создания пользователей** в поле **Первичная группа** указать **_vdi-web_**, а в поле **Оболочка** 
     указать **_/sbin/nologin_**. Снять переключатели в **Создавать новую пользовательскую группу** и 
     **Добавлять пользователя в дополнительные группы**
     ![image](../../_assets/vdi/how_to/new_user_scenario.PNG);
     
    - войти в **Политики учетной записи** → **Политика паролей** и активировать переключатель 
     **Применять для пользователя root**
     ![image](../../_assets/vdi/how_to/password_policy.PNG)
      
Этап установки **VeiL Broker** можно считать завершенным. Далее переходите к работе в соответствии с 
[Руководством оператора VeiL Broker](../operator_guide/prepare.md).

## Дополнительная информация

### Проверка статуса служб системы
Описание служб системы доступно в разделе [Службы системы](./services.md).

### Отключение механизмов AUTH Astra Linux на стороне брокера
В сценарии использования, при котором нет необходимости задействовать **PAM**-аутентификацию, целесообразно деактивировать
данный параметр в приложении. Деактивация существенно увеличит производительность механизма AUTH.

Для этого в файле настроек `/opt/veil-vdi/app/common/local_settings.py` необходимо
заменить стандартные значения ключей `LOCAL_AUTH` и `PAM_AUTH` на: 

```python
LOCAL_AUTH = True
PAM_AUTH = False
```

!!! warning "Предупреждение"
    Параметры являются взаимоисключающими, поэтому редактировать нужно оба.

После установки параметров необходимо перезапустить службы системы либо выполнить полную перезагрузку сервера (службы
 запускаются в автоматическом режиме).

!!! warning "Предупреждение"
    Отключение параметра `PAM_AUTH`, как правило, делает невозможным автоматическое включение его обратно, т.к. между 
    пользователями системы (Astra Linux) и брокера появится расхождение.

### Настройка PAM
Описанная ниже информация носит рекомендательный характер. Обратите внимание, что данные настройки могут привести к
полной блокировке доступа в систему.

!!! note "PAM"
    Pluggable Authentication Modules (**PAM**, подключаемые модули аутентификации) — это набор разделяемых библиотек, 
    которые позволяют интегрировать различные низкоуровневые методы аутентификации в виде единого высокоуровневого API.

При стандартной установке **VeiL Broker** параметр **PAM_AUTH** включен, что позволяет переложить функции локальной службы
авторизации на **ОС Astra Linux**, в которой выполнена установка. 

Сам процесс настройки **PAM** в системе не является
параметрами **VeiL Broker**, однако, за основу можно взять следующий пример:

!!! example "/etc/pam.d/common-auth"
    ```
    # force vdi-web check
    auth required pam_succeed_if.so user ingroup vdi-web
    ```    

!!! example "/etc/pam.d/login"
    ```
    # change default delay
    auth optional pam_faildelay.so delay=1000000
    ```

!!! warning "Предупреждение"
    Не забудьте добавить в указанную группу пользователя, под которым выполняется вход в GUI для администрирования.

Дальнейшее описание работы с системой авторизации доступно [здесь](../auth_v3/info.md).

### Настройка фаервола
Для настройки фаервола необходимо выполнить следующее:

- создать файл конфигурации фаервола c помощью команды

  `vim etc/ufw/aplications.d/vdi-broker`

- ввести следующую конфигурацию

  `[veil-broker]`

  `title=VeiL-broker`

  `description=Ports for VeiL-Broker`

  `ports=443,80,6379/tcp`

- перезапустить фаервол c помощью команды

  `ufw reload`

- обновить конфигурацию и открыть порты, выполнив последовательно команды:

  `ufw reload`

  `ufw allow veil-broker`.