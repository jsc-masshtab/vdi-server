# Обновление VeiL Broker с 3.2.0 на 4.0.0

Обновление происходит посредством переноса базы данных с одной ВМ на другую. Это связано с переходом 
на новые версии ОС Astra Linux, Python и PostgreSQL.

## Миграция данных VeiL Broker 3.2.0 на версию 4.0.0

1. Необходимо обновить **VeiL Broker** до версии 3.2.0 ([инструкция по обновлению](update_v3.md)).

    !!! note "Примечание"
        Проверить текущую версию **VeiL Broker** и его компонентов можно командой `dpkg -l | grep veil`.

2. Создать резервную копию Базы данных ([инструкция по созданию резервной копии](backup.md)).

3. Установить **ОС Astra Linux Special Edition версии 1.7 релиз Смоленск** на новую ВМ 
([инструкция по установке ОС](../engineer_guide/install_os/1-7.md)).

4. Установить на новую ВМ **VeiL Broker 4.0.0** ([инструкция по установке](install_v3.md)).

5. Перенести файл резервной копии Базы данных с ВМ с версией **VeiL Broker** 3.2.0 на ВМ с версией **VeiL Broker** 4.0.0
в каталог с полными правами чтения/записи (например в каталог **/tmp**).

6. Выполнить восстановление Базы данных из резервной копии ([инструкция по восстановлению БД](backup.md)).

7. Произвести вход в Web-интерфейс брокера по https://server_ip_address, где необходимо указать IP-адрес сервера. 
По умолчанию пользователь **_vdiadmin_** и пароль **_Bazalt1!_** 
(все остальные локальные пользователи не будут доступны - см. п.10). Список назначенных IP-адресов можно посмотреть в 
таблице ВМ интерфейса **ECP VeiL** или в самой ВМ в окне приложения **Терминал Fly** с помощью команды `ip a`.

8. Если ранее была настроена **Служба каталогов**, в настройках на брокере необходимо обновить пароль пользователя 
(учетной записи, используемой для синхронизации групп и пользователей из MS AD).

9. Если ранее были добавлены контроллеры, то необходимо обновить их токены в настройках на брокере.

    !!! note "Примечание"
        Токен генерируется в свойствах пользователя на **ECP VeiL** - *Ключ интеграции*. 
        Создание ключа интеграции выполняется в соответствии с 
        [руководством оператора ECP VeiL](https://veil.mashtab.org/docs/latest/base/operator_guide/security/users/#_10).

10. Если ранее были созданы локальные пользователи, то необходимо задать им новые (или повторить ранее заданные) пароли. 

    !!! note "Примечание"
        Данные пользователи будут созданы в **ОС Astra Linux Special Edition версии 1.7 релиз Смоленск**.
