# Обновление VeiL Broker с 3.2.0 на 4.0.0

Обновление происходит посредством переноса (миграции) базы данных с одной ВМ на другую. Это связано с переходом 
на новые версии ОС Astra Linux, Python и PostgreSQL.

## Миграция данных VeiL Broker 3.2.0 на версию 4.0.0

1. Необходимо обновить **VeiL Broker** до версии 3.2.0 ([инструкция по обновлению](update_v3.md)).
Проверить текущую версию **VeiL Broker** и его компонентов можно командой `dpkg -l | grep veil`.

1. Создать резервную копию базы данных ([инструкция по созданию резервной копии](backup.md)).

1. Установить **ОС Astra Linux Special Edition версии 1.7 релиз Смоленск** на новую ВМ 
([инструкция по установке ОС](../engineer_guide/install_os/1-7.md)).

1. Установить на новую ВМ **VeiL Broker 4.0.0** ([инструкция по установке](install_v3.md)).

1. Перенести файл резервной копии базы данных с ВМ с версией **VeiL Broker** 3.2.0 на ВМ с версией **VeiL Broker** 4.0.0
в каталог с полными правами чтения/записи (например, в каталог **/tmp**).

1. Выполнить восстановление базы данных из резервной копии ([инструкция по восстановлению БД](backup_db/ver_3_2_0/creating_db.md)).

1. Сменить ревизию в базе данных на актуальную (для версии 4.0.0 актуальная ревизия 4610585ad97d). Для этого 
зайти  на машину где запущен VDI по ssh (пароль Bazalt1! server_ip_address - адрес VDI):

    ```
    ssh astravdi@server_ip_address
    ```

1. Создать пользователя vdi, указав пароль Bazalt1!:

    ```
    sudo adduser vdi
    ```
    
1. Выполнить:

    ```
    sudo -u vdi  psql
    ```
    
    ```
    UPDATE alembic_version SET version_num=4610585ad97d WHERE version_num=a76ge5d8oo2f; 
    ```

1. Выполнить вход в Web-интерфейс **VeiL Broker** по `https://server_ip_address`, где необходимо указать IP-адрес сервера. 
По умолчанию пользователь **_vdiadmin_** и пароль **_Bazalt1!_** 
(все остальные локальные пользователи не будут доступны). Список назначенных IP-адресов можно посмотреть в 
таблице ВМ интерфейса **ECP VeiL** или в самой ВМ в окне приложения **Терминал Fly** с помощью команды `ip a`.

1. Если ранее была настроена **Служба каталогов**, то в настройках **VeiL Broker** необходимо обновить пароль пользователя 
(учетной записи, используемой для синхронизации групп и пользователей из MS AD).

1. Если ранее были добавлены контроллеры, то необходимо обновить их токены в настройках **VeiL Broker**. 
Токен генерируется в свойствах пользователя на **ECP VeiL** (**Безопасность** - **Пользователи** - <имя пользователя> - **Ключ интеграции**. 
Создание ключа интеграции выполняется в соответствии с 
[руководством оператора ECP VeiL](https://veil.mashtab.org/docs/latest/base/operator_guide/security/users/#_10).

1. Если ранее были созданы локальные пользователи, то необходимо задать им новые (или повторить ранее заданные) пароли. 



##  Обновление VeiL Broker с 4.x.x на 4.x.x

Обновление производится аналогично обновлению с 3.x.x на 3.x.x ([инструкция по установке](install_v3.md)).
