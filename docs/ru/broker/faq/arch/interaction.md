# Взаимодействие компонентов VeiL VDI

## Подключение пользователя к ВРМ

Пользователь при работе с тонким клиентом, персональным компьютером или ноутбуком запускает клиентское программное обеспечение **VeiL Connect**. В окне программы пользователь вводит свои учетные данные и совершает вход в программу. В этот момент **VeiL Connect** обращается к **Veil Broker** для подтверждения введенных данных пользователя, и в случае успешного входа **VeiL Broker** предоставляет список доступных пользователю пулов ВРМ.

Далее пользователь в **VeiL Connect** выбирает необходимый пул ВРМ и, при необходимости, протокол подключения из предоставленного списка. В этот момент **VeiL Connect** отправляет запрос к **Veil Broker** с требованием предоставить данные для подключения к выбранному ВРМ. 

При получении данного запроса **Veil Broker** обращается к **ECP VeiL** для получения данных для подключения к ВРМ. В случае отсутствия свободных ВМ в выбранном автоматическом пуле и если после создания клона ВМ не будет превышено общее количество ВМ в автоматическом пуле, **VeiL Broker** создает задачу в **ECP VeiL** на создание клона ВМ и, при необходимости, задачу на ввод в домен нового клона. В данные для подключения помимо служебной информации входят:

- Статус ВМ. Если ВМ выключена, то автоматически создается задача на запуск ВМ;
- IP адрес ВМ для подключения по протоколу RDP с использованием QEMU-агент из пакета **VeiL-Utils**;
- IP адрес контроллера или сервера виртуализации и порт для подключения по протоколу SPICE.

После получения данных от **ECP VeiL**, **VeiL Broker** дает ответ **VeiL Connect**, в котором либо сообщает данные для подключения и происходит подключение, либо сообщает о невозможности подключения к ВРС, о чем **VeiL Connect** информирует пользователя.

## Администрирование VeiL VDI

При создании пула виртуальных машин в Web-интерфейсе **VeiL Broker** администратором, **VeiL Broker** запрашивает у **ECP VeiL** доступные **Пулы ресурсов**. Далее администратор выбирает **Пул ресурсов**, на котором будет выполнено создание виртуальных машин. После чего **VeiL Broker** получает список ВМ или списки пулов данных и шаблонов ВМ, если создаваемый пул является автоматическим.

Следующим шагом администратор выбирает из списка ВМ или пул данных и шаблон ВМ, а также прочую информацию, если создаваемый пул является автоматическим и подтверждает создание пула. После этого, а также при расширении автоматического пула или добавления ВМ в пул, **VeiL Broker** создает запросы к **ECP VeiL** на выполнение следующих задач:

- Создание клонов ВМ, если пул является автоматическим;
- Введение ВМ в домен, изменение hostname, если пула автоматический;
- Включение удаленного доступа к ВМ;
- Создание тегов и применение к ВМ в **ECP VeiL** для удобства администрирования.

При удалении ВМ из пулов, а также при удалении пулов  **VeiL Broker** при необходимости создает запросы к **ECP VeiL** на выполнение следующих задач:

- Удаление ВМ, в том числе клонов;
- Удаление тегов;