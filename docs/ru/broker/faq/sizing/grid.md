# Рекомендации к использованию vGPU

Нагрузки на ресурсы **vGPU** при использовании **VDI** различаются для каждой задачи и зависят от многих факторов, включая количество и типы используемых приложений, размеры файлов, количество мониторов и их разрешение.

Подбор моделей графических адаптеров и их количества необходимо провести по результатам анализа потребления ресурсов **vGPU** пользователями. Рекомендуется выполнить сбор и анализ данных о пиковых нагрузках при использовании программного обеспечения которое планируется использовать при работе пользователями в дальнейшем.

При проектировании решения ВРС с использованием **vGPU** следует учитывать что один физический сервер может иметь 1 и более физических адаптеров, например NVIDIA, но при этом физический адаптер может быть разделен только на однотипные виртуальные адаптеры.

Например: **NVIDIA GRID P100X** можно поделить на 2 **P100X-8Q**, но нельзя поделить на 1 **P100X-8Q** и 2 **P100X-4Q**. Если требуется использовать на одном сервере разные типы **vGPU** следует установить под каждый тип **vGPU** свой графический адаптер.

## Потребление ресурсов ВМ

### vGPU

Количество выделенных **vGPU** включенным ВМ может быть больше, чем имеющееся количество **GPU** на сервере. Соотношение числа выделенных виртуальным машинам **vGPU** к общему количеству **GPU** называется **коэффициент переподписки vGPU:GPU** и считается по формуле ```vGPU/GPU```. 

Выбирать коэффициент переподписки при проектировании следует с осторожностью, отталкиваясь от специфики выполняемых задач.
Предположим, что для группы пользователей ситуация когда более 25% пользователей, одновременно выполняют ресурсоемкие операции требующие 100% вычислительной мощности **GPU**, является нетипичной, и вероятность ее возникновения стремится к нулю. Тогда, при проектировании VDI допустимо использовать коэффициент переподписки **vGPU:GPU** равный 3-4. Это позволит увеличить максимально возможное количество пользователей, или сократить физическое количество GPU в четыре раза, по сравнению с вариантом без  переподписки. 
Однако, если для группы пользователей типична ситуация, когда большинство пользователей выполняет ресурсоемкие операции в течении всего рабочего дня, и все ВМ задействованы постоянно с загрузкой vGPU 50% и выше, то будет правильным уменьшить коэффициент переподписки **vGPU:GPU** до 2 или менее (если загрузка vCPU>50%), или вовсе принять равным единице. 

Для определения подходящего **коэффициента переподписки GPU** стоит провести анализ активности пользователей и среднего количества одновременного выполнения задач связанных с высокими нагрузками на CPU. 

### Объем памяти vGPU

Рекомендуется, чтобы **объем памяти vGPU**, используемый при выполнении рабочих задач, в пике нагрузки не превышал **70÷90%**. Использование более **90%** памяти **vGPU** виртуальной машиной может привести к снижению производительностью и сбоям.

Определение необходимого объема графической памяти следует производить исходя из системных требований программного обеспечения, а также путем моделирования стандартных рабочих нагрузок. 

### CPU

Так как все процессы, в том числе использующие **GPU**, выполняются с использованием **CPU**, при недостаточном количестве выделенных **vCPU** или при неправильно выбранном **коэффициенте переподписки CPU:vCPU** произойдет снижение производительности. Также при использовании **vGPU** часть задач по кодированию и декодированию видео некоторых популярных кодеков берет на себя **vGPU**, таким образом при выполнении некоторых задач нагрузка на **CPU** может быть снижена.

Для предотвращения снижения производительности по причине высокой очереди на выполнения задач процессорами сервера рекомендуется использовать коэффициент переподписки **CPU:vCPU** в пределах 1-2 (не более2) при использовании совместно с видеоадаптером.

##  Примеры расчетов

В таблице ниже представлены рекомендуемые варианты использования **NVIDIA GRID** в зависимости от типа профиля (рабочих нагрузок) пользователя. Подробная информация о типах профилей содержится в разделе [Профили использования](profiles.md) .

| Профиль                | vCPU | RAM (Mb) | Переподписка vCPU:CPU | vGPU |Переподписка vGPU:GPU |
|:-----------------------|:----:| :-------:|:---------------------:|:----:|:--------------------:|
| Тип 1                  | 2    | 2048     | 8                     |  -   | -                    |
| Тип 2                  | 2    | 4096     | 4                     | 1B   | 16                   |
| Тип 3                  | 4    | 4096     | 4                     | 2B   | 8                    |
| Тип 4                  | 4    | 8192     | 2                     | 4Q   | 4                    |
| Тип 6                  | 8    | 8192     | 2                     | 8Q   | 2                    |
| Тип 6                  | 8    | 16384    | 1                     | 8Q   | 2                    |