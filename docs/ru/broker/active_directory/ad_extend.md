# Расширенная интеграция

Расширенная интеграция позволяет использовать службу каталогов как внешнюю службу авторизации, выполнять предварительную
синхронизацию пользователей, заводить ВРС на Windows в домен.

!!! note "Примечание"
    Пользователю, созданному в процессе интеграции, запрещен вход в систему до тех пор, пока не будет выполнен сброс
    пароля администратором системы. После сброса пароля пользователь сможет выполнять вход как через AD, так и 
    с использованием локального пароля.

!!! warning "Внимание"
    Функция ввода ВМ в домен Free IPA носит экспериментальный характер.

## Добавление службы каталогов

Добавление службы каталогов производится с помощью кнопки **Добавить службу каталогов** 
в разделе **Настройки -> Службы каталогов**. 

В открывшемся окне необходимо заполнить следующие поля:

   - Название;
   - Домен (записывается в формате domain);
   - Класс объекта домена (записывается в формате domain.local);
   - URL (записывается в формате ldap://xxx.xxx.xxx.xxx);
   - Тип службы (Active Directory или Free IPA);
   - Пользователь (учетная запись в AD, с использованием которой будет выполняться синхронизация, 
     пользователь должен иметь права на чтение атрибутов пользователей и списка групп);
   - Пароль.

!!! example "Пример формы создания"
    ![image](../../_assets/vdi/active_directory/base_ad.png)
    
В результате будет запись в статусе **Исправно**, если статус другой - необходимо обратиться к разделу
**Журнал -> События**, где будет указана информация о проблеме.

!!! warning "Внимание"
    Обратите внимание на поле **Пользователь**. Для авторизации на AD будет использована учетная запись
    по паттерну **Домен\Пользователь**. Если **Пароль** или **Пользователь** не указан, попытка подключения будет 
    проигнорирована. Проверить корректность введенных данных можно кнопкой **Проверка соединения**.

## Добавление соответствия

Раздел соответствия предназначен для сопоставления системных ролей с атрибутами пользователей MS AD при входе в
    систему с использованием внешней службы авторизации. При авторизации каждому пользователю
    автоматически будут назначены **Роли/Группы**, которые указаны в настройках соответствия.

!!! note "Примечание"
    Чтобы пользователь получил возможность входа в панель администратора, группа, в которую он будет включен, должна иметь
    одну или несколько системных ролей (SECURITY_OPERATOR, ADMINISTRATOR, OPERATOR), либо пользователь должен иметь
    атрибут **Администратор**. 

Добавление соответствия производится с помощью кнопки **Добавить соответствия** в разделе **Соответствия** созданной
ранее службы каталогов.
В открывшемся окне необходимо заполнить следующие поля:

   - Выберите группу (локальная группа на брокере, в которую будет включен внешний пользователь);
   - Приоритет (вес соответствия при коллизиях соответствий);
   - Тип атрибута службы каталогов (тип атрибута объекта MS Active Directory);
   - Значение атрибута службы каталогов (значение атрибута объекта MS Active Directory).

!!! example "Пример формы создания"
    ![image](../../_assets/vdi/active_directory/base_ad_mapping.png)

## Синхронизация пользователей группы AD

Синхронизация группы позволит единомоменто перенести всех пользователей-членов группы AD в локальную систему.

!!! note "Примечание"
    Повторная синхронизация ранее синхронизированной группы исключит из группы отключенных пользователей и добавит новых.

Добавление группы пользователей производится с помощью кнопки **Добавить группу** в разделе **Группы** созданной
ранее службы каталогов. В появившемся окне необходимо выбрать требуемую группу, в дальнейшем из неё будут синхронизированы
все пользователи.

### Шаги синхронизации группы MS AD

Процесс синхронизации делится на 2 шага:

- Получение групп доступных для синхронизации.  
  
  Группы доступные для синхронизации формируются из списка всех объектов с категорией **ГРУППА**, не являющиеся критичными 
  системными объектами и имеющие атрибут **Глобальная группа безопасности**, за исключением групп ранее синхронизированных 
  на VDI.
  
    !!! note "Примечание"
        Если список групп пустой, проверьте параметры учетной записи указанной для службы каталогов.

- Выбор конкретной группы и получение ее членов. 
  
    Одномоментно можно синхронизировать только одну группу. Это сделано в целях снижения нагрузки на MS AD. 
    Пользователи, доступные для синхронизации, формируются из списка объектов с категорией **ПОЛЬЗОВАТЕЛЬ** или 
    **ПЕРСОНА**, классом **ПОЛЬЗОВАТЕЛЬ**, не имеющие статус **ЗАБЛОКИРОВАН** и состоящие в выбранной группе.

!!! info "Фильтры, используемые при построении списка групп MS AD"
    `(&(objectCategory=GROUP)(groupType=-2147483646)(!(isCriticalSystemObject=TRUE))`

!!! info "Фильтры, используемые при построении списка групп Free IPA"
    `(&(objectclass=posixAccount)(objectclass=person)(!(nsaccountlock=TRUE))`

!!! info "Фильтры, используемые при построении списка пользователей MS AD"
    ```
    base_filter = '(&(sAMAccountName=*)'
    locked_account_filter = '(!(userAccountControl:1.2.840.113556.1.4.803:=2))'
    persons_filter = '(|(objectCategory=USER)(objectCategory=PERSON))(objectClass=USER)'
    member_of_filter = '(memberOf={})'.format(groups_cn)
    final_filter = ''.join([base_filter, locked_account_filter, persons_filter, member_of_filter, ')'])
    ```

!!! info "Фильтры, используемые при построении списка пользователей Free IPA"
    ```
    "(&(objectclass=posixAccount)(objectclass=person)(!(nsaccountlock=TRUE))"
    ```

## Подготовка ВМ

Если в системе существует активная служба каталогов с расширенной интеграцией, а также образ ВМ основан на ОС Windows,
существует возможность автоматизации процесса ввода ВМ в домен и включение заведенных компьютеров в группы MS AD.

!!! note "Примечание"
    Автоматическая подготовка ВМ требует как **настройки брокера**, так и подготовки **эталонного образа**, из которого будут
    создаваться новые ВМ. Более детально процесс рассмотрен в [профильном разделе](./ad_vm_prepare.md).

!!! warning "Внимание"
    Функция ввода ВМ в домен Free IPA носит экспериментальный характер.
