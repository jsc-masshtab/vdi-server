# Установка VeiL Broker 
 
!!! info "Установка из полученного qcow-образа диска"
    Предварительно необходимо определиться с пулом данных **ECP VeiL** на котором будет размещен диск будущей 
    виртуальной машины брокера. Определяющим фактором при выборе является доступное свободное место, желательно 
    выбирать пул данных на котором свободно не менее 40 ГБ. 
    Также, удобно будет заранее настроить сеть, в рамках которой будет работать будущая установка брокера. 
 
## Загрузка qcow-образа на пул данных и создание ВМ 
Образ может быть загружен как с локальной файловой системы, так и напрямую по URL.

### Загрузка по URL:  
1. В разделе **Файлы** подходящего пула данных выбираем **Загрузка по URL** и дожидаемся окончания загрузки файла.
!!! note ""
    если загрузка образа по URL не работает — убедитесь, что на сервере настроен DNS или используйте ссылку с ip-адресом
1. Открываем окно информации о загруженном нами образе и нажимаем **Импортировать**.  
1. С помощью мастера создания ВМ создаем новую виртуальную машину с использованием ранее импортированного диска.
 
!!! info "Характеристики ВМ брокера"
    рекомендуемые характеристики ВМ брокера - CPU cores: 2, CPU priority: High, RAM: 4096 MB.
    
!!! note "" 
    **Тип шины/Bus type** диска должен быть SCSI — это критично для версий до 2.2.*. 
 
<hr/> 
 
## Установка пакетов VDI 
1. Войдите в систему и активируйте режим администратора. 
!!! note "Стандартные данные для подключения"
    Стандартный пользователь для подключения *user*, пароль - *veil*, порт - 22. Не забудьте установить собственные пароли.

1. Перейдите в домашний каталог пользователя и запустите установочный скрипт
!!! warning "Суперпользователь"
    Убедитесь, что установка выполняется с правами суперпользователя (root).
!!! example "Запуск установки"
    `cd /home/user && bash install.sh`

1. Перед установкой скрипт уточнит у Вас параметры для экспорта журналов. 
!!! warning "Каталог для экспорта журналов"
    Убедитесь, что выбранный каталог доступен пользователю *postgres*, если есть сомнения - выберите каталог /tmp/.  
    После установки изменить выбранный каталог не получится.

1. Проверьте статусы сервисов
!!! example ""
    `supervisorctl status` - сервисы имеющие в названии *vdi-* должны иметь статус *RUNNING* 

1. Если все предыдущие шаги завершены успешно и ВМ имеет доступ к сети — можете перейти на Web-интерфейс панели администратора брокера для дальнейшей настройки 
 
<hr/> 
 
## Первичная настройка брокера VDI в панели администратора 
1. Перед настройкой брокера создайте на **ECP VeiL** пользователя, под которым будет происходить взаимодействие с VDI*
!!! info "Токен интеграции"
    пользователь должен состоять в группе "Администратор" и иметь собственный ключ интеграции. 

1. Подготовьте Шаблоны или образы ВМ, с которыми планируется дальнейшая работа
!!! note ""
    шаблон для автоматического пула обязательно должен иметь диск, иначе он не будет показан для выбора
    
1. Войдите в панель администратора через Web-интерфейс по ip-адресу ВМ, на которой 
установлен брокер с использованием локальной учетной записи администратора
!!! note "Стандартные данные для подключения"
    имя пользователя *admin*, пароль *veil*. Не забудьте установить собственные пароли.
    
1. Перейдите в раздел "Настройки -> Лицензирование" и загрузите предоставленный Вам лицензионный ключ
!!! note ""
    лицензионный ключ должен иметь расширение **key**. Если ключ загружен успешно, значение "Доступно тонких клиентов" будет больше 0. 
    
1. Перейдите в раздел "Контроллеры" и добавьте контроллер, на котором планируется дальнейшая работа ВМ
!!! note ""
    поле IP-адрес должно содержать только ipv4-адрес, разделенный точками без указания протокола и порта
 
<hr/> 