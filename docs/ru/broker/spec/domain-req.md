# Подготовка сервера к установке VeiL Broker

## Характеристики сервера/ВМ

**CPU** / **CPU PRIORITY** - 4 / HIGH

**RAM** / **VDISK** - 4 / 40 GB

!!! note "Проблемы с мышкой с подключением по SPICE"
    Если после установки в ВМ возникают проблемы с мышкой:
    1. Воспользуйтесь вкладкой *noVNC*
    2. Обновите spice-vdagent до более актуальной версии (spice-vdagent_0.18.0-1_amd64)
    3. Если не помог пункт 2: выключите ВМ, смените графический адаптер на **qxl**,
       добавьте новый USB2.0 контроллер *ehci*, удалите базовый USB3.0 контроллер *nec xhci* 
       и включите ВМ.

## Установка системы 

1. Выбирая имя учётной записи администратора нужно иметь в виду, что имя **vdiadmin** будет в дальнейшем 
   использовано брокером, поэтому необходимо выбрать другое имя, например, **astravdi**.

1. Выбирая компоненты системы обязательно должны быть выбраны **Базовые средства** и 
   **Средства удаленного доступа SSH**, желательно выбрать **Рабочий стол Fly**.
   
    !!! warning "Предупреждение"
        Обратите внимание, что некорректный выбор **Дополнительных настроек ОС** может привести
        к блокировке установки брокера, либо к затруднениям в его работе. Выбирайте данные пункты
        меню, подразумевайте дальнейшую настройку системы.

1. После завершения установки войдите в систему указав значение **Integrity level** равное **63** или 
   **Уровень целостности** равное **Высокий** (для графического режима).

1. Подключить iso-образ **основного** диска Astra Linux Smolensk 1.6, выполнить команды для копирования 
   deb-пакетов в систему:
```bash
sudo mount /media/cdrom
sudo mkdir /opt/main
sudo cp -r /media/cdrom/pool /media/cdrom/dists /opt/main/
sudo umount /media/cdrom
```

1. Подключить iso-образ **devel** диска Astra Linux Smolensk 1.6, выполнить команды для 
   копирования deb-пакетов в систему
```bash
sudo mount /media/cdrom
sudo mkdir /opt/devel
sudo cp -r /media/cdrom/pool /media/cdrom/dists /opt/devel/
sudo umount /media/cdrom
```

1. Настроить локальный apt-репозиторий, приведя файл **/etc/apt/sources.list** к виду
```
deb file:///opt/main smolensk contrib main non-free
deb file:///opt/devel smolensk contrib main non-free
```

1. Обновить списки пакетов командой `sudo apt-get update`

## Подготовка ВМ

Для корректной работы ВМ на ECP VeiL необходимо выполнить установку гостевого агента на систему.
1. Подключите образ в гостевыми утилитами к ВМ на ECP VeiL
```
* Перейдите в раздел **Виртуальные машины** и выберите ВМ с установленной ранее Astra linux
* Перейдите в раздел CD-ROM и нажмите кнопку "Монтировать образ veil utils*
```

2. Монтируйте образ внутри сеанса ВМ, например 
```
mount /media/cdrom
```

3. Выполните установку гостевого агента 
```
sudo dpkg -i /media/cdrom/linux/qemu-guest-agent/qemu-guest-agent_2.8+dfsg-6+deb9u13_amd64.deb
```

!!! example "Пример"
    ![image](../../_assets/vdi/how_to/guest_list.png)

4. Перезагрузите ВМ.
Если установка прошла успешно, то в разделе `Информация ВМ` появится значение IP-адреса ВМ.
   
!!! example "Пример"
    ![image](../../_assets/vdi/how_to/guest_info.png)
