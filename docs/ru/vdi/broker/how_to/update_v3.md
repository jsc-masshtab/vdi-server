# Обновление VeiL Broker 3.0.X

## Обновление из Astra linux

!!! info ""
    Проверить текущую версию VeiL Broker и его компонентов можно командой `dpkg -l | grep veil`

!!! warning ""
    Во время обновления сервис будет недоступен. Выберите допустимое время, выполните резервное копирование ВМ.

1. Войдите в систему указав значение **Integrity level** равное **63** или **Уровень целостности**
   равное **Высокий** (для графического режима).
!!! note "Стандартные репозитории пакетов"
    Если при установке были пропущены шаги по копированию стандартных дистрибутивов Astra Linux, ознакомьтесь с шагами
    по копированию **основного** и **devel** дисков в разделе * [Установка системы](./install_v3.md)

1. Подключите свежий iso-образ **VeiL Broker** и выполните 
   команды для обновления
```
sudo umount /media/cdrom
sudo mount /media/cdrom
cd ~
sudo bash /media/cdrom/install.sh
sudo umount /media/cdrom
```

## Миграция данных VeiL Broker 2.0 на версию 3.0.0

Перед началом миграции нужно убедиться, что все контроллеры активны и к ним можно 
подключиться. Скрипт миграции предоставляется по запросу.

### Команды для запуска на версии 2

1. Подключиться к серверу на котором размещен VeiL VDI 2.1.4
```
если используется более ранняя версия, необходимо сначала обновить ее до 2.1.4
```

2. Выполнить установку пакета vdi-migration-tool 
```
sudo dpkg -i vdi-migration-tool_1.0-1_all.deb
```

3. Запустить скрипт миграции
```
cd /opt/veil-vdi/app && ./migrate.sh -v 2
```

4. Выполните перенос получившихся файлов
```
/tmp/broker_pt_1.sql
/tmp/broker_pt_2.sql
/tmp/broker_pt_3.sql
```

### Команды для запуска на версии 3
1. Подключиться к серверу на котором размещен VeiL VDI 3.0.0
```
* Если планируется использовать версию новее - сначала нужно будет выполнить установку 3.0.0
* ssh-подключение к версии 3.0.0 заблокировано - используйте SPICE/VNC управление с контроллера ECP VeiL.
```

2. Разместите дампы на сервере в каталоге tmp
```
Дампы должны быть загружены в каталог к которому будет доступ у пользователя vdiadmin.
/tmp/broker_pt_1.sql
/tmp/broker_pt_2.sql
/tmp/broker_pt_3.sql 
```

3. Выполнить установку пакета vdi-migration-tool 
```
sudo dpkg -i vdi-migration-tool_1.0-1_all.deb
```

4. Запустить скрипт миграции
```
cd /opt/veil-vdi/app && ./migrate.sh -v 3
```

5. Задайте вновь созданным заблокированным пользователем пароли
```
На момент миграции в версии 3.0.0 не должно быть иных пользователей, кроме, vdiadmin.
```