# Руководство оператора VeiL Connect

## Описание

Veil Connect предназначен для удаленного подключения к виртуальным рабочим столам (ВРС) 
на базе ОС семейства Windows(по протоколам Spice и RDP) и Linux(по протоколу Spice).

!!! note "ОС на базе ядра Linux"
    - Astra Linux Special Edition **Смоленск** версия 1.6 и выше
    - Astra Linux Common Edition **Орел** версия 1.6 и выше
    - Debian 9 и выше
    - Ubuntu 18.04 LTS и выше
    - Centos 7 и выше
    - Astra Linux Common Edition **Орел** в режиме киоска

!!! note "ОС Windows"
    - Windows 7
    - Windows 8.1
    - Windows 10
    - Windows Server 2008 R2
    - Windows Server 2012
    - Windows Server 2012 R2
    - Windows Server 2016
    - Windows Server 2019

Veil Connect обеспечивает:

- воспроизведение видео в разрешении до FullHD в Web-браузере и в
отдельном приложении-плеере при удаленном подключении к ВРС

- воспроизведение gif- и flash-анимации без замирания картинки в Web-браузере или приложении для 
просмотра gif- и flash-анимации при удаленном подключении к ВРС

- комфортную работу САПР Autocad при работе с 3D-графикой при удаленном подключении к ВРС.

!!! note ""
    Выполняется только с предварительной подготовкой виртуальной машины (ВМ) на ECP VeiL, 
    включающей подключение к ВМ виртуальной видеокарты nVidia с поддержкой технологии GRID, 
    установку драйверов виртуальной видеокарты, подключение лицензии виртуальной видеокарты и 
    установку приложения Spice-tools при подключении по протоколу Spice
    [пример](../broker/how_to/vm/nvidia.md)

- воспроизведение звука без прерываний при подключении к ВРС

- интеграцию со службой каталогов для хранения учетных записей и данных пользователей (**LDAP** или **AD**)

- прохождение процедуры авторизации и аутентификации с использованием локальных учетных записей
пользователей VeiL Broker

- прохождение процедуры авторизации и аутентификации на тонком клиенте с использованием учетных
записей пользователей на удаленном контролере LDAP (AD)
  
- подключение к ВРС следующих устройств:
    - манипулятор типа **мышь** через интерфейс USB
    - клавиатура через интерфейс USB
    - накопитель flash через интерфейс USB
    - накопитель на жестком диске через интерфейс USB
    - наушники через интерфейс TRS 3,5 mm
    - динамики через интерфейс TRS 3,5 mm
    - микрофон через интерфейс TRS 3,5 mm
    - Web-камера через интерфейс USB

!!! note "Примечание"
    При наличии соответствующих разъёмов в аппаратной платформе.

## Условия выполнения программы

Для нормального функционирования Veil Connect требуется ПЭВМ, технические характеристики которой не должны уступать
приведенным ниже:
!!! note ""
- процессор с частотой не менее 1 ГГц

- объем оперативной памяти – не менее 1 Гбайт (для 32-bit системы) и не
менее 2 Гбайт (для 64-bit системы)

- свободное дисковое пространство не менее 130 Мб

- постоянное запоминающее устройство – не менее 1 Гбайт

- интерфейсы сетевые – не менее 1 Гбит Ethernet, в количестве не менее одного.

### Условия на ОС Linux
Для нормального функционирования Veil Connect на ОС Linux требуется наличие
общесистемных программных средств среды функционирования прикладных
программ ОС Linux семейства Debian/Ubuntu и следующих пакетов:
!!! note ""
- spice-client-gtk

- libspice-client-gtk-3.0-dev

- libjson-glib-dev

- libxml2-dev
    
- libsoup2.4-dev
    
- freerdp2-dev
    
- libfreerdp-client2- 2

- libwinpr2- 2
  
- libwinpr2-dev

- libhiredis-dev
    
    
!!! note ""
При установке Veil Connect на ОС Linux все необходимые зависимости установятся автоматически из стандартного источника 
пакетов ОС.

### Условия на ОС Windows
Для нормального функционирования Veil Connect на ОС Windows требуется наличие общесистемных
программных средств среды функционирования прикладных программ ОС Windows и 
[Microsoft Visual C++ Redistributable](https://support.microsoft.com/en-us/help/2977003/the-latest-supported-visual-c-downloads)    

1. Для обеспечения функционирования Veil Connect на ОС Windows с поддержкой подключения USB устройств к ВРС 
требуется наличие библиотеки  [UsbDk](https://github.com/daynix/UsbDk/releases/download/v1.00-22/UsbDk_1.0.22_x64.msi)

## Выполнение программы

### Подготовка к работе
- Перед началом работы пользователю необходимо у администратора системы виртуализации получить параметры авторизации 
(имя учетной записи и пароль), с которыми он в дальнейшем будет работать. Если в корпоративной сети настроена 
автоматическая сквозная авторизация, то параметрами авторизации для входа в Veil Connect будет имя учетной записи и 
пароль используемые для входа в ОС

- Если учетная запись не была создана, то необходимо воспользоваться учетной записью администратора
    
### Общие правила при работе с программой
- Все действия выполняются одинарным нажатием левой клавиши графического манипулятора (далее по тексту – нажатием 
клавиши) на объект (егоизображение или название), на который в данный момент указывает курсор

- При работе с окнами существует возможность их разворачивания на весь экран при нажатии на кнопку 
![image](../../_assets/vdi/maximize.png), сворачивание окна при нажатии на кнопку 
![image](../../_assets/vdi/minimize.png), закрытие окна при нажатии на кнопку 
![image](../../_assets/vdi/cross.png)
    
- Для комфортной работы с интерфейсом программы рекомендуется разрешение экрана **1920*1080**. При меньшем разрешении 
экрана часть элементов интерфейса может быть скрыта

### Выполнение программы

#### Запуск программы на ОС Linux
- включить ПЭВМ и авторизоваться в ОС с логином и паролем с правами пользователя, под именем которого будет 
производиться работа с программой

- открыть главное меню графической оболочки ОС

- в строке поиска необходимо набрать без кавычек **Veil Connect**

- двойным нажатием левой клавиши манипулятора **мышь** запустить найденное приложение Veil Connect. 
Также приложение можно найти в меню (в зависимости от ОС) Приложения->Система / Приложения->Сеть / Приложения->Интернет

#### Запуск программы на ОС Windows
- включить ПЭВМ и авторизоваться в ОС с логином и паролем с правами пользователя, под именем которого будет 
производиться работа с программой

- Запуск программы происходит через меню **Пуск** или с помощью ярлыка **Veil Connect** расположенного на рабочем столе 
ОС Windows, если такой был создан во время установки программы

#### Окно авторизации пользователя и настройка соединения
- В результате запуска программы появляется окно настройки авторизации пользователя, содержащее область ввода 
параметров авторизации, кнопку **Войти** и ссылку **Настройки**

- При выборе **Настройки**->**Основные** открывается окно мастера настройки подключения **Veil Connect** к серверу 
**Veil Broker**, содержащее область для ввода параметров подключения к серверу **Veil Broker**, переключатели 
**Внешняя служба авторизации** и **Автоподключение**, а также кнопки **Отменить** и **Сохранить**

В области ввода параметров подключения к серверу Veil VDI необходимо задать следующие данные

!!! example ""
- доменное имя или ip-адрес сервера Veil VDI (вводится в формате **xxx.xxx.xxx.xxx**), к которому будет производиться 
подключение

- порт сервера Veil VDI, через который будет производиться подключение (по умолчанию используется ** 443 **)

- имя домена (Windows AD или LDAP) для авторизации пользователя по протоколу rdp в ВМ, которая находится в том же домене,
что и учетная запись пользователя. Данный параметр может оставаться незаполненным
  
- Установка маркера в чек-боксе рядом с переключателем **Внешняя служба авторизации** сообщает серверу Veil Broker о 
том, что учётная запись пользователя хранится в домене AD (LDAP). Настройка подключения к хранилищу учётных данных 
пользователей производится в настройках **Veil Broker**

- Установка маркера в чек-боксе рядом с переключателем **Автоподключение** приведет к автоматическому подключению к 
предыдущему выбранному пулу, минуя окно выбора пула
     
- На вкладке **Настройки**->**SPICE** существует возможность включения опции **Показывать клиентский курсор**. 
Это может исправить проблему **пропадания** курсора внутри ВМ в некоторых ОС
    
- На вкладке **Настройки**->**RDP** присутствуют настройки RDP соединения 
   
Большинство настроек RDP должно быть произведено перед подключением к ВМ. 

!!! example "Возможные настройки"
- Задание формата изображения (BGRA16, BGRA32)

- FPS (сколько раз в секунду обновляется изображение)

- Перенаправляемые папки.  Папки для проброса на ВМ. Задать их можно вручную, перечислив
через точку с запятой, либо воспользоваться файловым менеджером, нажав **Добавить папку**

- Мультимониторность. При выборе этого пункта будут использованы до 3 мониторов

- Запустить приложение. Это режим работы RDP, при котором запускается и доступно только одно выбранное приложение

- h264. Использование видео кодека h264

- При нажатии на кнопку **Сохранить** происходит сохранение настроек и возврат в окно настройки авторизации пользователя

- В области ввода параметров авторизации необходимо ввести имя пользователя и пароль, полученные у администратора 
системы виртуализации или учетные данные пользователя домена

- После ввода параметров авторизации и настройки соединения необходимо нажать кнопку **Войти**

#### Окно доступных пулов ВМ

- После успешной авторизации и настройки параметров соединения пользователь переходит в окно доступных пулов ВМ, в 
верхней части которого расположены кнопки **Обновить** и **Выйти**, а в нижней части - статусная строка, в
которую выводятся информационные сообщения о функционировании программы

- Главная рабочая область окна содержит список доступных пулов ВМ с предустановленными протоколами подключения к ВРС

!!! note "Протоколы подключения к ВРС"    
- Протокол Spice используется тогда, когда подключение к ВМ производится средствами ECP VeiL. На стороне ECP VeiL на 
каждом узле, на котором запускаются ВМ, реализован Spice-server. Подключение происходит через контроллер ECP VeiL,
что требует наличия сетевой доступности контроллера ECP VeiL для клиентского устройства, с которого производится 
подключение к ВМ. При выборе Spice_direct подключение произойдет также по протоколу Spice, но напрямую к узлу, 
где находится ВМ.
    
- RDP-native вызывает встроенный Windows-клиент **mstsc.exe**

- RDP использует собственную реализацию rdp-клиента

ОС Windows в ВМ должна быть предварительно настроена администратором или средствами Group Policy домена AD на прием 
подключений по протоколу RDP для пользователя AD, с которым будет подключаться пользователь.
    
Графическое изображение изменяется в зависимости от состояния, в котором находится пул, который может быть помечен 
текстовыми полями **CREATING** и **FAILED**. Если пул создается, то он помечается надписью **CREATING**. Если пул 
недоступен, то он помечается красным прямоугольником, содержащим надпись **FAILED**. Если пул находится в рабочем 
состоянии, то он активен для выбора пользователем.
    
Для загрузки доступного пула необходимо нажать на его графическое изображение. Программа отправит запрос на получение 
ВМ из пула и, если в составе пула у пользователя есть доступ к ВМ, то произойдет ее подключение и запуск. Если ВМ не 
удалось получить из пула или в пуле нет свободных ВМ, то соответствующее сообщение появится в статусной строке рабочей 
области окна.

- В окне существует возможность обновить список доступных пулов ВМ с помощью кнопки **Обновить**

- Выход из окна осуществляется при нажатии на кнопку **Выход**

!!! note ""
Если при попытке подключения к пулу по RDP появилось сообщение **Нет соединения ERRCONNECT_LOGON_FAILURE**, 
это значит, что либо задан неверный домен (начальное окно->**Настройки**->**Основные**->**Домен**), либо учетная 
запись на ВМ не совпадает с учетной записью на VDI брокере (логин/пароль)

#### Окно ВМ

После успешного запуска ВМ пользователю будет представлено окно работы с ВМ, в котором существует возможность настройки 
ВМ (горизонтальное меню в верхней части экрана), а также форма авторизации в ОС ВМ. Из-за различий в протоколах окна 
SPICE и RDP имеют некоторые отличия.

##### Элементы управления общие для SPICE и RDP
- Оперативное управление ВМ осуществляется с помощью горизонтального меню, расположенного в верхней части окна ВМ и 
содержащего горизонтального меню, расположенного в верхней части окна ВМ и содержащего следующие пункты – **Настройки**,
**Вид**, **USB устройства**, **Управление**, **Послать сочетания клавиш** и **Помощь**

- При выборе пункта меню **Настройки** в раскрывающемся списке будут доступны подпункты **Скриншот**, **Общие папки** 
и **Закрыть**

- При выборе подпункта **Скриншот** ВМ делает снимок экрана рабочей области и открывает окно сохранения скриншотов. 
В данном окне существует возможность задать имя файла изображения и выбрать каталог сохранения. При нажатии на кнопку 
**Save** файл с заданным именем и расширением **.png** сохраниться в выбранный каталог
  
- Для сохранения настроек и закрытия окна необходимо нажать на кнопку ![image](../../_assets/vdi/cross.png)
   
- При выборе подпункта **Закрыть** открывается окно с предложением закрыть сессию. Для закрытия сессии необходимо нажать 
кнопку **OK**, а при отмене действия кнопку **Cancel**. Установка маркера в чек-боксе рядом с переключателем 
**Не спрашивать снова** позволяет в дальнейшем не выводить окно с предложением закрыть программу. В результате нажатия 
кнопки **ОК** произойдет разрыв соединения с ВМ и завершение сеанса в Veil Connect.

- При выборе пункта меню **Управление** в раскрывающемся списке будут доступны команды **Отключиться**, **Включить**, 
**Приостановить**, **Выключить**, **Выключить форсировано**, **Перезагрузить**, **Перезагрузить форсировано**

- При выборе команды **Отключиться** произойдет завершение сеанса работы ВМ и автоматическое закрытие окна ВМ. 
Настройки, заданные во время сессии, не сохранятся. На экране отобразится окно доступных пулов ВМ.

- Выбор команды **Приостановить** приостанавливает работу ВМ, ОС ВМ не выгружается из памяти и не высвобождает ресурсы

- Выбор команды **Включить** запускает дальнейшую работу ВМ, которая была остановлена командой **Приостановить**

- При выборе команды **Выключить** ОС ВМ может вывести сообщение о невозможности самостоятельно завершить работу, 
например, при наличии открытых приложений. Пользователю будет предложено либо самостоятельно закрыть все удерживающие 
процессы, либо ОС ВМ сама автоматически завершит работу приложений и выключится. После чего произойдет автоматическое 
закрытие окна ВМ и на экране отобразится окно доступных пулов ВМ

- При выборе **Выключить форсировано** ОС ВМ без предупреждения завершит работу приложений, если они открыты, и 
выключится. Окно ВМ автоматически закроется и на экране отобразится окно доступных пулов ВМ

- При выборе команды **Перезагрузить** ОС ВМ может вывести сообщение о невозможности самостоятельно осуществить 
перезагрузку, например, при наличии открытых приложений. Пользователю будет предложено либо самостоятельно закрыть 
все удерживающие процессы, либо ОС ВМ сама автоматически завершит работу приложений и начнет перезагружаться

- При выборе команды **Перезагрузить форсировано** ОС ВМ без предупреждения автоматически завершает работу приложений, 
если они открыты, и начинает процесс перезагрузки

- При выборе пункта меню **Послать сочетания клавиш** в раскрывающемся списке будут доступны команды:
    - **Ctrl+Alt+Del**
    
    - **Ctrl+Alt+Backspace**
    
    - **Ctrl+Alt+F1**
    
    - **Ctrl+Alt+F2**
    
    - **Ctrl+Alt+F3**
    
    - **Ctrl+Alt+F4**
    
    - **Ctrl+Alt+F5**

    - **Ctrl+Alt+F6**

    - **Ctrl+Alt+F7**

    - **Ctrl+Alt+F8**

    - **Ctrl+Alt+F9**

    - **Ctrl+Alt+F10**

    - **Ctrl+Alt+F11**

    - **Ctrl+Alt+F12**

    - **PrintScreen**

Реакция на передаваемое сочетание клавиш соответствует ОС, установленной в ВМ, к которой подключен пользователь.

- При выборе пункта меню **Помощь** в раскрывающемся списке будут доступны подпункты **Официальная страница ЕСР Veil**, 
**Документация** и **О программе**

- При выборе подпункта **Официальная страница ЕСР Veil** открывается официальная страница программы в браузере, 
заданном по умолчанию в **родительской** ОС

- При выборе пункта меню **Документация** в браузере будет открыта текущая документация

- При выборе подпункта **О программе** открывается окно содержащее графический символ программы Veil Connect, 
номер версии и ссылку, при нажатии на которую появляется информация об организации осуществившей разработку
программы. Для закрытия информационного окна необходимо нажать кнопку **Close**

- Отключение от работающей ВМ и закрытие программы осуществляется при нажатии на кнопку ![image](../../_assets/vdi/cross.png)

##### Описание графического интерфейса SPICE.
 
- При выборе **Настройки** -> **Общие папки** открывается окно настройки
общей папки для обмена файлами между тонким клиентом и ОС ВМ. На вкладке с
именем протокола подключения необходимо в раскрывающемся списке выбрать имя
папки и установить маркер в чек-боксе рядом с переключателем **Общая папка**.
Установка маркера в чек-боксе рядом с переключателем **Только для чтения**
позволяет настроить режим, при котором файлы, находящиеся в общей папке
доступны ОС ВМ только для чтения.
    
!!! note "Примечание"
    Для возможности проброса папок по spice необходима предварительная настройка. См. ниже.  
   - При выборе пункта меню **Вид** в раскрывающемся списке будут
    доступны подпункты: **Полный экран**, **Масштаб** и **Displays**

   - Установка маркера в чек-боксе рядом с переключателем **Полный
    экран** вызывает команду перехода окна ВМ в полноэкранный режим. Окно ВМ
    займет всю область отображения, а окно операционной системы будет
    располагаться по центру. В полноэкранном режиме становится недоступным
    горизонтальное меню. Переключить вид окна и получить доступ к меню можно при
    помощи всплывающего тулбара в нижней средней части окна от настроек
    используем ос. Выход из полноэкранного режима осуществляется при помощи
    нажатия на соответствующую кнопку, появляющуюся при наведении на середину в
    верхней границе окна

   - При выборе подпункта **Масштаб** становятся доступны команды
    **Уменьшить**, **Увеличить** и **К размеру виртуальной машины**. Команды
    **Уменьшить** и **Увеличить** уменьшают или увеличивают размер окна ВМ. При
    этом разрешение окна ОС ВМ остается постоянным. Для возврата окна ВМ к
    исходному размеру необходимо выполнить команду **К размеру виртуальной
    машины**

   - При выборе подпункта **Displays** открывается окно, в котором
    существует возможность указать нужный дисплей ВМ, если у нее их несколько.

   - При выборе пункта меню **USB устройства** станет доступным подпункт
    **Проброс USB**, при нажатии на который открывается окно с приглашением выбрать
    USB устройства для подключения **Selected USB devices to redirect (n free channels)**,
    где **n** – это количество свободных каналов для подключения. При отсутствии возможности 
    подключения USB устройств (значение **n** равно
    **0**) в окне выводится уведомление **![image](../../_assets/vdi/attention.png) The connected VM 
    is not configured for USB redirеction** и список переключателей будет недоступен.
    Если проброс USB устройств в ВМ возможен, то в окне необходимо из
    предложенного списка выбрать устройство, установив маркер в чек-боксе рядом с
    его именем. После успешного подключения устройства пользователь увидит
    уведомление **![image](../../_assets/vdi/redirect.png)Redirecting USB Device...**.
    Для закрытия окна и подтверждения изменения параметров необходимо нажать
    на кнопку **Close**. В чек-боксе рядом с переключателем **USB устройства** в
    главном меню установится маркер выбора.

##### Описание графического интерфейса RDP.
 
- По умолчанию RDP окно раскрывается на полный экран. Для выхода из режима полного экрана
нужно переместить курсор мыши в верхнюю центральную область экрана и нажать на всплывающую
кнопку **Покинуть полный экран**
    
- При выборе пункта меню **Вид** в раскрывающемся списке будет доступен подпункт:
  **Полный экран**. При нажатии на эту кнопку окно перейдет в полноэкранный
режим

- При выборе пункта меню **USB устройства** и нажатии на подпункт **Проброс USB** 
откроется окно выбора устройств для перенаправления. Для проброса устройства 
необходимо поставить маркер напротив соответствующего названия USB  

#### Настройки для возможности перенаправления папок по Spice

- Текущий пользователь должен иметь право на перенаправление папок (Задается администратором в Web-интерфейсе [Разрешения](../broker/permissions.md)). 

!!!example "Veil Connect запущен на хосте с Linux/Windows. На ВМ установлен Linux"
    - В гостевой ВМ установить spice-webdavd service командой sudo apt install spice-webdavd
    - Запустить сервис командой sudo spice-webdavd -p 8000
    - С Veil Connect подключиться к ВМ
    - В меню **Настройки** выбрать **Общие папки**. В открывшемся окне выбрать папку на хосте, которую хотим расшарить.
    - Поставить галочку "Общая папка". Закрыть окно.
    - В сетевых папках ВМ появится пункт Spice client folder. Нажать на него, чтобы открыть расшаренную папку.

!!! example "Veil Connect запущен на хосте с Linux. На ВМ установлен Windows"
    - В гостевой ВМ установить [spice-webdavd-x64-latest](https://www.spice-space.org/download/windows/spice-webdavd/)
    - Открыть командную строку, перейти в папку "C:\Program Files\SPICE webdavd" и выполнить скрипт map-drive.bat
    - С Veil Connect подключиться к ВМ.
    - В меню **Настройки** выбрать **Общие папки**. В открывшемся окне выбрать папку на хосте, которую хотим расшарить.
    - Поставить галку "Общая папка". Закрыть окно.
    - В ВМ появится новый сетевой диск Spice client, на котором будет содержимое расшаренной папки.

#### Настройки для возможности перенаправления USB (Spice и RDP)

- Текущий пользователь должен иметь право на перенаправление USB (Задается администратором в Web-интерфейсе [Разрешения](../broker/permissions.md)).

- В веб интерфейсе ECP VeiL у ВМ должен быть добавлен USB Spice канал (USB-устройства -> Подключить)

- В веб интерфейсе ECP VeiL у ВМ должен быть добавлен USB контроллер nec-xhci (USB3.0) (Контроллеры)

- Если Veil Connect запущен на машине с ОС Windows, то там необходимо установить
[UsbDk](https://github.com/daynix/UsbDk/releases/download/v1.00-22/UsbDk_1.0.22_x64.msi)

- Если на ВМ установлены ОС Windows 7 или Windows Server 2008, то для корректной работы USB на этих 
машинах должнен быть установлен драйвер [NEC USB 3.0 Driver](https://support.lenovo.com/ru/en/downloads/ds018533)

- Для перенаправления USB при подключении по RDP на данный момент необходимо, чтобы машина, где запущен 
Veil Connect (ТК), и узел, где находится ВМ, были взаимодоступны в сети (т. е. чтобы с узла проходил пинг до машины ТК). 
 Также для перенаправления USB необходимо, чтобы на машине, где запущен Veil Connect, были открыты на прием 
TCP соединений порты 17777-17782.
