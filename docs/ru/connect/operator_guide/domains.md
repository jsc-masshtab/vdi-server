# Окно ВМ

После успешного запуска ВМ пользователю будет представлено окно работы с ВМ, в котором 
существует возможность настройки ВМ (горизонтальное меню в верхней части экрана), а также 
форма авторизации в ОС ВМ. Из-за различий в протоколах окна SPICE и RDP имеют некоторые отличия.

## Элементы управления общие для SPICE и RDP

Оперативное управление ВМ осуществляется с помощью горизонтального меню, расположенного в 
верхней части окна ВМ и содержащего горизонтального меню, расположенного в верхней части 
окна ВМ и содержащего следующие пункты: 

- **Настройки**;
- **Вид**; 
- **USB устройства**; 
- **Управление**; 
- **Послать сочетания клавиш**;
- **Помощь**.

При выборе пункта меню **Настройки** в раскрывающемся списке будут доступны 
подпункты **Скриншот**, **Общие папки** и **Закрыть**.

При выборе подпункта **Скриншот** ВМ делает снимок экрана рабочей области и 
открывает окно сохранения скриншотов. В данном окне существует возможность задать 
имя файла изображения и выбрать каталог сохранения. При нажатии на кнопку 
**Save** файл с заданным именем и расширением *.png* сохранится в выбранный каталог.
   
При выборе подпункта **Закрыть** открывается окно с предложением закрыть сессию. 
Для закрытия сессии необходимо нажать кнопку **OK**, а при отмене действия кнопку **Cancel**. 
Установка маркера в чек-боксе рядом с переключателем **Не спрашивать снова** позволяет 
в дальнейшем не выводить окно с предложением закрыть программу. В результате нажатия 
кнопки **ОК** произойдет разрыв соединения с ВМ и завершение сеанса в VeiL Connect.

При выборе пункта меню **Управление** в раскрывающемся списке будут доступны команды 
**Отключиться**, **Включить**, **Приостановить**, **Выключить**, **Выключить форсировано**, 
**Перезагрузить**, **Перезагрузить форсировано**.

При выборе команды **Отключиться** произойдет завершение сеанса работы ВМ и 
автоматическое закрытие окна ВМ. Настройки, заданные во время сессии, не сохранятся. 
На экране отобразится окно доступных пулов ВМ.

Выбор команды **Приостановить** приостанавливает работу ВМ, ОС ВМ не выгружается 
из памяти и не высвобождает ресурсы.

Выбор команды **Включить** запускает дальнейшую работу ВМ, которая была остановлена 
командой **Приостановить**.

При выборе команды **Выключить** ОС ВМ может вывести сообщение о невозможности 
самостоятельно завершить работу, например, при наличии открытых приложений. 
Пользователю будет предложено либо самостоятельно закрыть все удерживающие 
процессы, либо ОС ВМ сама автоматически завершит работу приложений и выключится. 
После чего произойдет автоматическое закрытие окна ВМ и на экране отобразится окно 
доступных пулов ВМ.

При выборе **Выключить форсировано** ОС ВМ без предупреждения завершит работу 
приложений, если они открыты, и выключится. Окно ВМ автоматически закроется и на 
экране отобразится окно доступных пулов ВМ.

При выборе команды **Перезагрузить** ОС ВМ может вывести сообщение о невозможности 
самостоятельно осуществить перезагрузку, например, при наличии открытых приложений. 
Пользователю будет предложено либо самостоятельно закрыть все удерживающие процессы, 
либо ОС ВМ сама автоматически завершит работу приложений и начнет перезагружаться.

При выборе команды **Перезагрузить форсировано** ОС ВМ без предупреждения автоматически 
завершает работу приложений, если они открыты, и начинает процесс перезагрузки.

При выборе пункта меню **Послать сочетания клавиш** в раскрывающемся списке будут 
доступны команды:
   - **Ctrl+Alt+Del**
    
   - **Ctrl+Alt+Backspace**
    
   - **Ctrl+Alt+F1**
    
   - **Ctrl+Alt+F2**
    
   - **Ctrl+Alt+F3**
    
   - **Ctrl+Alt+F4**
    
   - **Ctrl+Alt+F5**

   - **Ctrl+Alt+F6**

   - **Ctrl+Alt+F7**

   - **Ctrl+Alt+F8**

   - **Ctrl+Alt+F9**

   - **Ctrl+Alt+F10**

   - **Ctrl+Alt+F11**

   - **Ctrl+Alt+F12**

   - **PrintScreen**

Реакция на передаваемое сочетание клавиш соответствует ОС, установленной в ВМ, к 
которой подключен пользователь.

При выборе пункта меню **Помощь** в раскрывающемся списке будут доступны подпункты **Официальная страница ЕСР VeiL**, 
**Документация** и **О программе**.

При выборе подпункта **Официальная страница ЕСР VeiL** открывается официальная страница программы в браузере, 
заданном *по умолчанию* в *родительской* ОС.

При выборе пункта меню **Документация** в браузере будет открыта текущая документация.

При выборе подпункта **О программе** открывается окно содержащее графический символ программы VeiL Connect, 
номер версии и ссылку, при нажатии на которую появляется информация об организации осуществившей разработку
программы. Для закрытия информационного окна необходимо нажать кнопку **Close**.

Отключение от работающей ВМ и закрытие программы осуществляется при нажатии на кнопку 
![image](../../_assets/vdi/cross.png).

## Описание графического интерфейса SPICE
 
При выборе **Настройки** -> **Общие папки** открывается окно настройки
общей папки для обмена файлами между тонким клиентом и ОС ВМ. На вкладке с
именем протокола подключения необходимо в раскрывающемся списке выбрать имя
папки и установить маркер в чек-боксе рядом с переключателем **Общая папка**.
Установка маркера в чек-боксе рядом с переключателем **Только для чтения**
позволяет настроить режим, при котором файлы, находящиеся в общей папке
доступны ОС ВМ только для чтения.
    
!!! note "Примечание"
    Для возможности проброса папок по spice необходима предварительная настройка.
  
При выборе пункта меню **Вид** в раскрывающемся списке будут
    доступны подпункты: **Полный экран**, **Масштаб** и **Displays**.

Установка маркера в чек-боксе рядом с переключателем **Полный
    экран** вызывает команду перехода окна ВМ в полноэкранный режим. Окно ВМ
    займет всю область отображения, а окно операционной системы будет
    располагаться по центру. В полноэкранном режиме становится недоступным
    горизонтальное меню. Переключить вид окна и получить доступ к меню можно при
    помощи всплывающего тулбара в нижней средней части окна от настроек
    используем ос. Выход из полноэкранного режима осуществляется при помощи
    нажатия на соответствующую кнопку, появляющуюся при наведении на середину в
    верхней границе окна.

При выборе подпункта **Масштаб** становятся доступны команды
    **Уменьшить**, **Увеличить** и **К размеру виртуальной машины**. Команды
    **Уменьшить** и **Увеличить** уменьшают или увеличивают размер окна ВМ. При
    этом разрешение окна ОС ВМ остается постоянным. Для возврата окна ВМ к
    исходному размеру необходимо выполнить команду **К размеру виртуальной
    машины**.

При выборе подпункта **Displays** открывается окно, в котором
    существует возможность указать нужный дисплей ВМ, если у нее их несколько.

При выборе пункта меню **USB устройства** станет доступным подпункт
    **Проброс USB**, при нажатии на который открывается окно с приглашением выбрать
    USB устройства для подключения **Selected USB devices to redirect (n free channels)**,
    где **n** – это количество свободных каналов для подключения. При отсутствии возможности 
    подключения USB устройств (значение **n** равно
    **0**) в окне выводится уведомление **![image](../../_assets/vdi/attention.png) The connected VM 
    is not configured for USB redirеction** и список переключателей будет недоступен.
    Если проброс USB устройств в ВМ возможен, то в окне необходимо из
    предложенного списка выбрать устройство, установив маркер в чек-боксе рядом с
    его именем. После успешного подключения устройства пользователь увидит
    уведомление **![image](../../_assets/vdi/redirect.png)Redirecting USB Device...**.
    Для закрытия окна и подтверждения изменения параметров необходимо нажать
    на кнопку **Close**. В чек-боксе рядом с переключателем **USB устройства** в
    главном меню установится маркер выбора.

## Описание графического интерфейса RDP
 
*По умолчанию* RDP окно раскрывается на полный экран. Для выхода из режима полного экрана
нужно переместить курсор мыши в верхнюю центральную область экрана и нажать на всплывающую
кнопку **Покинуть полный экран**.
    
При выборе пункта меню **Вид** в раскрывающемся списке будет доступен подпункт **Полный экран**. 
При нажатии на эту кнопку окно перейдет в полноэкранный режим.

При выборе пункта меню **USB устройства** и нажатии на подпункт **Проброс USB** 
откроется окно выбора устройств для перенаправления по протоколу **usbredir**. Для проброса устройства 
необходимо поставить маркер напротив соответствующего названия USB. Данный функционал не поддерживается для RDS 
пула. Используйте перенаправление USB с помощью RemoteFX  [Выбрать USB для перенаправления](../settings/rdp_settings.md).

## Настройки для возможности перенаправления папок по Spice

Текущий пользователь должен иметь право на перенаправление папок (Задается администратором в Web-интерфейсе 
[Разрешения](../../broker/auth_v3/client-permissions.md)). 

!!! example "VeiL Connect запущен на хосте с Linux/Windows. На ВМ установлен Linux"
    - В гостевой ВМ установить *spice-webdavd service* командой 
`sudo apt install spice-webdavd`.
    - Запустить сервис командой `sudo spice-webdavd -p 8000`.
    - С VeiL Connect подключиться к ВМ.
    - В меню **Настройки** выбрать **Общие папки**. В открывшемся окне выбрать папку на хосте, 
    которую хотим расшарить.
    - Поставить галочку **Общая папка**. Закрыть окно.
    - В сетевых папках ВМ появится пункт **Spice client folder**. Нажать на него, чтобы 
    открыть расшаренную папку.

!!! example "VeiL Connect запущен на хосте с Linux. На ВМ установлен Windows"
    - В гостевой ВМ установить 
    [spice-webdavd-x64-latest](https://www.spice-space.org/download/windows/spice-webdavd/).
    - Открыть командную строку, перейти в папку *C:\Program Files\SPICE webdavd* и выполнить скрипт *map-drive.bat*.
    - С VeiL Connect подключиться к ВМ.
    - В меню **Настройки** выбрать **Общие папки**. В открывшемся окне выбрать папку на хосте, 
    которую хотим расшарить. 
    - Поставить галочку **Общая папка**. Закрыть окно.
    - В ВМ появится новый сетевой диск *Spice client*, на котором будет содержимое расшаренной папки.

## Настройки для возможности перенаправления USB (Spice и RDP)

Текущий пользователь должен иметь право на перенаправление USB (Задается администратором в Web-интерфейсе 
[Разрешения](../../broker/auth_v3/client-permissions.md)).

Если VeiL Connect запущен на Linux, то пользователь должен иметь разрешение на открытие USB 
(Выполнить chmod 666 для устройства / добавить пользователя в группу, владеющую устройством / изменить 
разрешения устройства).

Для перенаправления по Spice в Web-интерфейсе ECP VeiL у ВМ должен быть добавлен USB Spice канал 
(**USB-устройства** -> **Подключить**).

В Web-интерфейсе ECP VeiL у ВМ должен быть добавлен USB-контроллер nec-xhci (USB3.0) (**Настройки** - **Контроллер**).

Если VeiL Connect запущен на машине с ОС Windows, то там необходимо установить
[UsbDk](https://github.com/daynix/UsbDk/releases/download/v1.00-22/UsbDk_1.0.22_x64.msi).

Если на ВМ установлены ОС Windows 7 или Windows Server 2008, то для корректной работы USB на этих 
машинах должнен быть установлен драйвер 
[NEC USB 3.0 Driver](https://support.lenovo.com/ru/en/downloads/ds018533).

Для перенаправления USB по протоколу *usbredir* при подключении по RDP необходимо, чтобы машина, где запущен 
VeiL Connect (ТК), и узел, где находится ВМ, были взаимодоступны в сети (т.е. чтобы с узла проходил пинг 
до машины ТК). 

Также для перенаправления USB необходимо, чтобы на машине, где запущен VeiL Connect, были открыты на прием 
TCP соединений порты 17777-17782.

Для перенаправления USB с использованием *RemoteFX* при подключении по RDP необходимо, чтобы 
удаленная машина поддерживала *RemoteFX*.
